<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <title>Test-map</title>
</head>
<body>
    
    <div id="map"></div>
    <div id="action-bar">
        <button id="btnreturn" onclick="returnScooter()">Zurückgeben</button>
    </div>

    <style>
        body {
            padding: 0;
            margin: 0;
        }
        html, body, #map {
            height: 100%;
            width: 100vw;
        }
        #action-bar {
            display: none;
            position: absolute;
            right: 0px;
            left: 0px;
            bottom: 0px;
            width: 100%;
            height: 15%;
            z-index: 400;
            background-color: #202123;
            text-align: center;
            overflow: hidden;
        }
        #action-bar button {
            font-size: 20px;
            color: white;
            font-family: 'Nunito', sans-serif;
            padding: 20px;
        }

    </style>
    {% load static %}
    <script>
        var map = L.map('map', {zoomControl: false}).fitWorld();

        L.tileLayer('https://tile.jawg.io/jawg-dark/{z}/{x}/{y}{r}.png?access-token=dzffigTwdQHUlNNFg0lfWIbJFJ5ohhOiViumMXwwZQNMgtUtyXiasK0bce9X8HsU', {
            maxZoom: 18,
            attribution: "<a href=\"https://www.jawg.io\" target=\"_blank\">&copy; Jawg</a> - <a href=\"https://www.openstreetmap.org\" target=\"_blank\">&copy; OpenStreetMap</a>&nbsp;"
        }).addTo(map);

        map.setView([51.1397, 7.21583], 15);

        let scootericon = L.icon({
                iconUrl: "{% static 'scooter-farbe.png' %}",
                iconSize:     [40, 40],
                popupAnchor:  [-8, -20]
            });
        

        // Scooter und Ladestationen laden
        let scooter, station;

        '{% for row in scooter_items %}'

        scooter = L.marker(['{{ row.latitude }}', '{{ row.longitude }}'], {icon: scootericon}).addTo(map);
        scooter.bindPopup("{{ row.name }} <br> Scooter-id: {{ row.scooter_id }} <br><br> Ladezustand: {{ row.state_of_charge }}% <br><br> <button id='btnAusleihen' onclick='rentScooter({{ row.scooter_id }}, {{ row.latitude }}, {{ row.longitude }})'>Ausleihen</button>");

        '{% endfor %}'

        '{% for row in station_items %}'

        station = L.circle(['{{ row.latitude }}', '{{ row.longitude }}'], {
            color: 'green',
            fillColor: 'green',
            fillOpacity: 0.2,
            radius: 50
        }).addTo(map);
        station.bindPopup("{{ row.name }} <br> Station-id: {{ row.station_id }}");

        '{% endfor %}'

        // Position anzeigen
        let marker, circle, zoomed;

        navigator.geolocation.watchPosition(success, error);

        map.on('click', onMapClick);

        let ziel, rights, routing;

        function onMapClick(pos) {
            if (rights === "ziel") {
                rights = "";
                //ziel = L.marker([pos.latlng.lat, pos.latlng.lng], {draggable:'true'}).addTo(map);

                routing = L.Routing.control({
                    show: false,
                    waypoints: [
                        L.latLng(lat, lng),
                        L.latLng(pos.latlng.lat, pos.latlng.lng)
                    ]
                }).addTo(map);

                routing.on('routesfound', function test(e){
                    console.log(e);
                    console.log(e.routes[0].summary.totalDistance, e.routes[0].summary.totalTime);

                    var actionBar = document.getElementById('action-bar');

                    actionBar.style.display = "block";

                    var myWidth = window.innerHeight * .85
                    var element = document.getElementById("map");
                    element.style.height = myWidth + "px";

                    window.onresize = function() {
                        var myWidth = window.innerHeight * .85
                        element.style.height = myWidth + "px";
                    };

                    //actionBar.innerHTML = e.routes[0].summary.totalDistance + " m " + (e.routes[0].summary.totalTime / 60) + " s";

                });
            }
        }

        function success(pos) {

            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;
            const accuracy = pos.coords.accuracy;

            if (marker) {
                map.removeLayer(marker);
                map.removeLayer(circle);
            }

            marker = L.marker([lat, lng]).addTo(map);
            circle = L.circle([lat, lng], { color: 'blue', fillColor: 'blue', fillOpacity: 0.1, radius: accuracy }).addTo(map);

            if (!zoomed) {
                zoomed = map.fitBounds(circle.getBounds());
            }

            // View anordnen
            //map.setView([lat, lng]);

        }


        function error(err) {
            if (err.code === 1) {
                alert("Bitte erlauben Sie die Standort nutzung");
            } else {
                alert("Standort nicht abrufbar");
            }
        }

        let lat, lng;

        function rentScooter(id, lat1, lng2) {
            alert("Wählen Sie das Ziel durch tippen auf die Karte aus");
            lat = lat1;
            lng = lng2;
            rights = "ziel";
        }

        function returnScooter() {
            //routing.spliceWaypoints(0, 2);
            //ziel.remove();

            if (confirm("Möchten Sie diesen Scooter wirklich zurückgeben?") == true) {
                map.removeControl(routing);

                var actionBar = document.getElementById('action-bar');
                actionBar.style.display = "none";

                var myHeight = window.innerHeight * .85
                var element = document.getElementById("map");
                element.style.height = "100%";
            }
            
        }

    </script>

</body>
</html>